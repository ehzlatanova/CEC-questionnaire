<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pré-évaluation CEC (Entrée express) — Questionnaire autonome</title>
  <style>
    :root { --bg:#0b0f14; --card:#121826; --muted:#9aa4b2; --text:#e6edf3; --accent:#3b82f6; --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444; }
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:linear-gradient(180deg,#070a0f, #0b0f14);color:var(--text);}
    .wrap{max-width:900px;margin:0 auto;padding:24px;}
    header{display:flex;gap:12px;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;}
    h1{font-size:20px;margin:0 0 6px 0;font-weight:700}
    .sub{color:var(--muted);font-size:13px;line-height:1.4;margin:0}
    .card{background:rgba(18,24,38,.92);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:18px;margin-top:16px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .grid{display:grid;grid-template-columns:1fr;gap:14px;}
    @media(min-width:860px){ .grid{grid-template-columns:1fr 1fr;} }
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    select,input{width:100%;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:#0b1220;color:var(--text);outline:none}
    input[type="number"]{appearance:textfield}
    .row{display:flex;gap:10px;align-items:center}
    .pill{display:inline-flex;align-items:center;gap:8px;border-radius:999px;padding:8px 12px;font-size:12px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04)}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    button{cursor:pointer;border:none;border-radius:12px;padding:10px 12px;font-weight:650}
    .primary{background:var(--accent);color:white}
    .ghost{background:transparent;color:var(--text);border:1px solid rgba(255,255,255,.18)}
    .tiny{font-size:12px;color:var(--muted)}
    .resultTop{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .badge{padding:8px 12px;border-radius:999px;font-weight:700;font-size:12px}
    .b-ok{background:rgba(34,197,94,.18);color:#86efac;border:1px solid rgba(34,197,94,.35)}
    .b-warn{background:rgba(245,158,11,.16);color:#fde68a;border:1px solid rgba(245,158,11,.35)}
    .b-bad{background:rgba(239,68,68,.16);color:#fecaca;border:1px solid rgba(239,68,68,.35)}
    .score{font-size:28px;font-weight:800}
    ul{margin:10px 0 0 18px;color:var(--text)}
    .muted{color:var(--muted)}
    .divider{height:1px;background:rgba(255,255,255,.10);margin:14px 0}
    .foot{margin-top:14px;color:var(--muted);font-size:12px;line-height:1.5}
    .hidden{display:none !important;}
    .hint{font-size:12px;color:var(--muted);margin-top:6px;line-height:1.35}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Pré-évaluation — Entrée express (CEC)</h1>
        <p class="sub">Questionnaire autonome (sans stockage). Remplis les champs, puis clique <b>Calculer</b> pour obtenir un verdict, un % et les éléments manquants.</p>
      </div>
      <div class="pill">
        <span class="mono">v2 • CEC</span>
      </div>
    </header>

    <div class="card">
      <div class="grid">
        <!-- Q1 -->
        <div>
          <label>1) Intention de résider hors Québec (EE = hors Québec)</label>
          <select id="q_outside_qc">
            <option value="unknown">Je ne sais pas / à confirmer</option>
            <option value="yes">Oui</option>
            <option value="no">Non</option>
          </select>
          <div class="hint">Si la personne souhaite s’établir au Québec, la CEC (Entrée express) n’est généralement pas la bonne voie.</div>
        </div>

        <!-- Q2 -->
        <div>
          <label>2) Mois d’expérience de travail canadienne qualifiée (dans les 3 dernières années)</label>
          <input id="q_months_can" type="number" min="0" step="1" placeholder="Ex. 14" />
          <div class="hint">Référence pratique : <b>12 mois</b> ≈ <b>1 560 h</b> (30 h/semaine × 52 semaines).</div>
        </div>

        <!-- Q3 -->
        <div>
          <label>3) Heures totales d’expérience canadienne qualifiée (si tu connais)</label>
          <input id="q_hours_can" type="number" min="0" step="10" placeholder="Ex. 1680" />
          <div class="hint">Si tu n’as pas le chiffre exact, laisse vide (on utilisera les mois).</div>
        </div>

        <!-- Q4 -->
        <div>
          <label>4) Expérience payée et obtenue avec autorisation de travail?</label>
          <select id="q_auth_paid">
            <option value="unknown">Je ne sais pas / à confirmer</option>
            <option value="yes">Oui</option>
            <option value="no">Non</option>
          </select>
          <div class="hint">Travail <b>sans autorisation</b> = généralement non comptabilisé.</div>
        </div>

        <!-- Q5 -->
        <div>
          <label>5) Expérience acquise en tant qu’étudiant à temps plein?</label>
          <select id="q_fulltime_student">
            <option value="unknown">Je ne sais pas / à confirmer</option>
            <option value="no">Non</option>
            <option value="yes">Oui</option>
          </select>
          <div class="hint">La CEC exclut généralement l’expérience acquise pendant des études à temps plein (exceptions rares).</div>
        </div>

        <!-- Q6 -->
        <div>
          <label>6) Travail autonome (self-employed) pour cette expérience?</label>
          <select id="q_self_employed">
            <option value="unknown">Je ne sais pas / à confirmer</option>
            <option value="no">Non</option>
            <option value="yes">Oui</option>
          </select>
          <div class="hint">La CEC exclut généralement l’expérience à titre de travailleur autonome.</div>
        </div>

        <!-- Q7 -->
        <div>
          <label>7) NOC 2021 / TEER de l’emploi principal</label>
          <select id="q_teer">
            <option value="unknown">Je ne sais pas / à confirmer</option>
            <option value="0-1">TEER 0–1</option>
            <option value="2-3">TEER 2–3</option>
            <option value="not_ok">Autre (TEER 4–5 / non admissible)</option>
          </select>
          <div class="hint">CEC exige une expérience dans un emploi <b>TEER 0, 1, 2 ou 3</b>.</div>
        </div>

        <!-- Q8 -->
        <div>
          <label>8) Test de langue valide (non expiré)?</label>
          <select id="q_lang_valid">
            <option value="unknown">Je ne sais pas / à confirmer</option>
            <option value="yes">Oui</option>
            <option value="no">Non</option>
          </select>
          <div class="hint">Entrée express : résultats généralement valides <b>2 ans</b>.</div>
        </div>

        <!-- Q9 -->
        <div>
          <label>9) Type de test linguistique</label>
          <select id="q_lang_test">
            <option value="unknown">Je ne sais pas / à confirmer</option>
            <option value="ielts">IELTS General Training (anglais)</option>
            <option value="celpip">CELPIP General (anglais)</option>
            <option value="tef">TEF Canada (français)</option>
            <option value="tcf">TCF Canada (français)</option>
          </select>
          <div class="hint">
            Le système convertit automatiquement en CLB/NCLC et retient le <b>niveau le plus bas</b> (celui qui compte).
            <br/>TEF (Entrée express) : saisir la colonne <b>« Équivalence ancien score »</b>.
          </div>
        </div>

        <!-- Q10 -->
        <div>
          <label>10) Compréhension orale (Listening / compréhension de l’oral)</label>
          <input id="q_lang_L" type="number" step="0.5" placeholder="IELTS: 7.5 | CELPIP: 9 | TEF: 280 | TCF: 503" />
        </div>

        <!-- Q11 -->
        <div>
          <label>11) Expression orale (Speaking / expression orale)</label>
          <input id="q_lang_S" type="number" step="0.5" placeholder="IELTS: 7.0 | CELPIP: 9 | TEF: 371 | TCF: 14" />
        </div>

        <!-- Q12 -->
        <div>
          <label>12) Lecture (Reading / compréhension de l’écrit)</label>
          <input id="q_lang_R" type="number" step="0.5" placeholder="IELTS: 6.5 | CELPIP: 8 | TEF: 233 | TCF: 499" />
        </div>

        <!-- Q13 -->
        <div>
          <label>13) Écriture (Writing / expression écrite)</label>
          <input id="q_lang_W" type="number" step="0.5" placeholder="IELTS: 6.5 | CELPIP: 8 | TEF: 310 | TCF: 10" />
          <div class="hint">CEC : <b>CLB/NCLC 7</b> si TEER 0–1, ou <b>5</b> si TEER 2–3.</div>
        </div>

        <!-- Q14 -->
        <div>
          <label>14) Autres infos utiles (optionnel)</label>
          <input id="q_notes" type="text" placeholder="Notes libres (non utilisées dans le calcul)" />
          <div class="hint">Ex. statut actuel, dates exactes, NOC, etc.</div>
        </div>
      </div>

      <div class="btns">
        <button class="primary" id="btn_calc">Calculer</button>
        <button class="ghost" id="btn_reset" title="Réinitialiser toutes les réponses">Réinitialiser</button>
      </div>
      <div class="foot">
        <div><b>Important :</b> ce questionnaire donne une pré-évaluation. Il ne remplace pas une analyse complète (preuves, admissibilité générale, etc.).</div>
      </div>
    </div>

    <div class="card hidden" id="card_result">
      <div class="resultTop">
        <div id="badge" class="badge b-warn">POTENTIELLEMENT ADMISSIBLE</div>
        <div class="score" id="score">—%</div>
      </div>

      <div class="divider"></div>

      <div class="row">
        <div>
          <div class="muted">Résumé</div>
          <div id="summary" style="margin-top:6px;line-height:1.5"></div>
        </div>
      </div>

      <div class="divider"></div>

      <div class="muted">Éléments manquants / à clarifier</div>
      <ul id="missing"></ul>

      <div class="divider"></div>
      <div class="muted">Détails du scoring</div>
      <ul id="details"></ul>

      <div class="foot">
        <div class="tiny">Astuce : tu peux adapter le texte et les règles dans le script (section <span class="mono">CONFIG</span>).</div>
      </div>
    </div>
  </div>

<script>
/**
 * Questionnaire autonome CEC — v2
 * Langue: type de test + 4 compétences -> CLB/NCLC auto (niveau le plus bas)
 */

/* =========================
   CONFIG
   ========================= */

const CONFIG = {
  weights: {
    experience: 35,
    teer: 20,
    language: 35,
    outsideQC: 10
  },

  clbRequired: {
    "0-1": 7,
    "2-3": 5
  },

  hardStops: [
    { id:"outsideQC", check:(a)=>a.outsideQC==="no", message:"La personne indique vouloir s’établir au Québec (Entrée express = hors Québec)." },
    { id:"authPaid", check:(a)=>a.authPaid==="no", message:"Expérience canadienne non obtenue légalement et/ou non payée (généralement non admissible)." },
    { id:"fulltimeStudent", check:(a)=>a.fulltimeStudent==="yes", message:"Expérience acquise pendant des études à temps plein (généralement exclue en CEC)." },
    { id:"selfEmployed", check:(a)=>a.selfEmployed==="yes", message:"Expérience à titre de travailleur autonome (généralement exclue en CEC)." },
    { id:"teerNotOk", check:(a)=>a.teer==="not_ok", message:"Emploi non admissible : la CEC requiert un emploi TEER 0–3." },
    { id:"langTestInvalid", check:(a)=>a.langValid==="no", message:"Test de langue invalide/expiré." },
    {
      id:"clbTooLow",
      check:(a)=>{
        if (a.teer !== "0-1" && a.teer !== "2-3") return false;
        const lang = computeLang(a);
        if (lang.min === null) return false; // inconnu -> pas hard stop
        return lang.min < CONFIG.clbRequired[a.teer];
      },
      message:"Niveau linguistique inférieur au minimum requis selon le TEER."
    },
    {
      id:"expTooLow",
      check:(a)=>{
        const hasHours = a.hours !== null;
        const hasMonths = a.months !== null;
        if (!hasHours && !hasMonths) return false;
        if (hasHours && a.hours < 1560) return true;
        if (!hasHours && hasMonths && a.months < 12) return true;
        return false;
      },
      message:"Moins de 12 mois (ou 1 560 h) d’expérience canadienne qualifiée dans les 3 dernières années."
    }
  ],

  unknownMessages: {
    outsideQC: "Intention de résider hors Québec : à confirmer.",
    months: "Durée d’expérience canadienne : à confirmer (mois/heures).",
    authPaid: "Autorisation + travail payé : à confirmer.",
    fulltimeStudent: "Études à temps plein durant l’expérience : à confirmer.",
    selfEmployed: "Travail autonome : à confirmer.",
    teer: "TEER/NOC : à confirmer (doit être TEER 0–3).",
    langValid: "Validité du test de langue : à confirmer.",
    langTest: "Type de test de langue : à confirmer (IELTS/CELPIP/TEF/TCF).",
    langScores: "Résultats de langue par compétence : à compléter (L/S/R/W)."
  }
};

/* =========================
   Helpers
   ========================= */
const $ = (id) => document.getElementById(id);

function addLi(listEl, text){
  const li = document.createElement("li");
  li.textContent = text;
  listEl.appendChild(li);
}

function toNumOrNull(v){
  if (v === null || v === undefined) return null;
  const s = String(v).trim();
  if (s === "") return null;
  const n = Number(s);
  return Number.isFinite(n) ? n : null;
}

function inRange(n,a,b){ return n >= a && n <= b; }

/* =========================
   Conversions langue (IELTS/CELPIP/TEF/TCF) -> CLB/NCLC
   ========================= */

function ieltsToCLB(score, skill){
  const s = score;
  if (skill === "R"){
    if (s >= 8.0) return 10;
    if (s >= 7.0) return 9;
    if (s >= 6.5) return 8;
    if (s >= 6.0) return 7;
    if (s >= 5.0) return 6;
    if (s >= 4.0) return 5;
    if (s >= 3.5) return 4;
    return 0;
  }
  if (skill === "W"){
    if (s >= 7.5) return 10;
    if (s >= 7.0) return 9;
    if (s >= 6.5) return 8;
    if (s >= 6.0) return 7;
    if (s >= 5.5) return 6;
    if (s >= 5.0) return 5;
    if (s >= 4.0) return 4;
    return 0;
  }
  if (skill === "L"){
    if (s >= 8.5) return 10;
    if (s >= 8.0) return 9;
    if (s >= 7.5) return 8;
    if (s >= 6.0) return 7;
    if (s >= 5.5) return 6;
    if (s >= 5.0) return 5;
    if (s >= 4.5) return 4;
    return 0;
  }
  if (skill === "S"){
    if (s >= 7.5) return 10;
    if (s >= 7.0) return 9;
    if (s >= 6.5) return 8;
    if (s >= 6.0) return 7;
    if (s >= 5.5) return 6;
    if (s >= 5.0) return 5;
    if (s >= 4.0) return 4;
    return 0;
  }
  return null;
}

function celpipToCLB(score){
  const s = Math.round(score);
  if (!Number.isFinite(s)) return null;
  return Math.max(0, s);
}

// TEF Canada (Entrée express) — équivalence ancien score
function tefOldToNCLC(score, skill){
  const s = score;
  if (skill === "S" || skill === "W"){
    if (inRange(s, 393, 450)) return 10;
    if (inRange(s, 371, 392)) return 9;
    if (inRange(s, 349, 370)) return 8;
    if (inRange(s, 310, 348)) return 7;
    if (inRange(s, 271, 309)) return 6;
    if (inRange(s, 226, 270)) return 5;
    if (inRange(s, 181, 225)) return 4;
    return 0;
  }
  if (skill === "L"){
    if (inRange(s, 316, 360)) return 10;
    if (inRange(s, 298, 315)) return 9;
    if (inRange(s, 280, 297)) return 8;
    if (inRange(s, 249, 279)) return 7;
    if (inRange(s, 217, 248)) return 6;
    if (inRange(s, 181, 216)) return 5;
    if (inRange(s, 145, 180)) return 4;
    return 0;
  }
  if (skill === "R"){
    if (inRange(s, 263, 300)) return 10;
    if (inRange(s, 248, 262)) return 9;
    if (inRange(s, 233, 247)) return 8;
    if (inRange(s, 207, 232)) return 7;
    if (inRange(s, 181, 206)) return 6;
    if (inRange(s, 151, 180)) return 5;
    if (inRange(s, 121, 150)) return 4;
    return 0;
  }
  return null;
}

// TCF Canada
function tcfToNCLC(score, skill){
  const s = score;
  if (skill === "R"){
    if (inRange(s, 549, 699)) return 10;
    if (inRange(s, 524, 548)) return 9;
    if (inRange(s, 499, 523)) return 8;
    if (inRange(s, 453, 498)) return 7;
    if (inRange(s, 406, 452)) return 6;
    if (inRange(s, 375, 405)) return 5;
    if (inRange(s, 342, 374)) return 4;
    return 0;
  }
  if (skill === "L"){
    if (inRange(s, 549, 699)) return 10;
    if (inRange(s, 523, 548)) return 9;
    if (inRange(s, 503, 522)) return 8;
    if (inRange(s, 458, 502)) return 7;
    if (inRange(s, 398, 457)) return 6;
    if (inRange(s, 369, 397)) return 5;
    if (inRange(s, 331, 368)) return 4;
    return 0;
  }
  if (skill === "W" || skill === "S"){
    if (inRange(s, 16, 20)) return 10;
    if (inRange(s, 14, 15)) return 9;
    if (inRange(s, 12, 13)) return 8;
    if (inRange(s, 10, 11)) return 7;
    if (inRange(s, 7, 9)) return 6;
    if (s === 6) return 5;
    if (inRange(s, 4, 5)) return 4;
    return 0;
  }
  return null;
}

function computeLang(a){
  const test = a.langTest;
  const rawL = a.langL, rawS = a.langS, rawR = a.langR, rawW = a.langW;

  if (test === "unknown") return { test, min: null, details: null, label: null };
  if ([rawL, rawS, rawR, rawW].some(v => v === null)) return { test, min: null, details: null, label: null };

  let L=null,S=null,R=null,W=null, label=null;

  if (test === "ielts"){
    label = "CLB (anglais)";
    L = ieltsToCLB(rawL,"L");
    S = ieltsToCLB(rawS,"S");
    R = ieltsToCLB(rawR,"R");
    W = ieltsToCLB(rawW,"W");
  } else if (test === "celpip"){
    label = "CLB (anglais)";
    L = celpipToCLB(rawL);
    S = celpipToCLB(rawS);
    R = celpipToCLB(rawR);
    W = celpipToCLB(rawW);
  } else if (test === "tef"){
    label = "NCLC (français)";
    L = tefOldToNCLC(rawL,"L");
    S = tefOldToNCLC(rawS,"S");
    R = tefOldToNCLC(rawR,"R");
    W = tefOldToNCLC(rawW,"W");
  } else if (test === "tcf"){
    label = "NCLC (français)";
    L = tcfToNCLC(rawL,"L");
    S = tcfToNCLC(rawS,"S");
    R = tcfToNCLC(rawR,"R");
    W = tcfToNCLC(rawW,"W");
  } else {
    return { test, min: null, details: null, label: null };
  }

  if ([L,S,R,W].some(v => v === null)) return { test, min: null, details: null, label: null };
  const details = { L, S, R, W };
  const min = Math.min(L,S,R,W);
  return { test, min, details, label };
}

/* =========================
   Read / Score / Evaluate
   ========================= */

function readAnswers(){
  const outsideQC = $("q_outside_qc").value;
  const monthsRaw = $("q_months_can").value;
  const hoursRaw = $("q_hours_can").value;
  const authPaid = $("q_auth_paid").value;
  const fulltimeStudent = $("q_fulltime_student").value;
  const selfEmployed = $("q_self_employed").value;
  const teer = $("q_teer").value;
  const langValid = $("q_lang_valid").value;

  const langTest = $("q_lang_test").value;
  const langL = toNumOrNull($("q_lang_L").value);
  const langS = toNumOrNull($("q_lang_S").value);
  const langR = toNumOrNull($("q_lang_R").value);
  const langW = toNumOrNull($("q_lang_W").value);

  const months = monthsRaw === "" ? null : Math.max(0, parseInt(monthsRaw,10));
  const hours  = hoursRaw === "" ? null : Math.max(0, parseInt(hoursRaw,10));

  return { outsideQC, months, hours, authPaid, fulltimeStudent, selfEmployed, teer, langValid, langTest, langL, langS, langR, langW };
}

function computeScore(a){
  const w = CONFIG.weights;
  let points = 0;
  let max = 0;
  const details = [];

  // outsideQC
  max += w.outsideQC;
  if (a.outsideQC === "yes") { points += w.outsideQC; details.push(`Hors Québec : +${w.outsideQC}`); }
  else if (a.outsideQC === "unknown") { const p=Math.round(w.outsideQC*0.5); points += p; details.push(`Hors Québec : +${p} (à confirmer)`); }
  else { details.push(`Hors Québec : +0`); }

  // experience
  max += w.experience;
  let expOk = null;
  if (a.hours !== null) expOk = a.hours >= 1560;
  else if (a.months !== null) expOk = a.months >= 12;

  if (expOk === true) { points += w.experience; details.push(`Expérience CAN (≥ 12 mois/1560h) : +${w.experience}`); }
  else if (expOk === null) { const p=Math.round(w.experience*0.45); points += p; details.push(`Expérience CAN : +${p} (à confirmer)`); }
  else { details.push(`Expérience CAN : +0`); }

  // teer
  max += w.teer;
  if (a.teer === "0-1" || a.teer === "2-3") { points += w.teer; details.push(`TEER admissible (0–3) : +${w.teer}`); }
  else if (a.teer === "unknown") { const p=Math.round(w.teer*0.45); points += p; details.push(`TEER : +${p} (à confirmer)`); }
  else { details.push(`TEER : +0`); }

  // language
  max += w.language;
  let langPts = 0;

  const testPart = Math.round(w.language * 0.35); // ~12
  const lvlPart  = w.language - testPart;         // ~23

  if (a.langValid === "yes") { langPts += testPart; details.push(`Test de langue valide : +${testPart}`); }
  else if (a.langValid === "unknown") { const p=Math.round(testPart*0.5); langPts += p; details.push(`Test de langue : +${p} (à confirmer)`); }
  else { details.push(`Test de langue : +0`); }

  const lang = computeLang(a);

  if (a.teer === "0-1" || a.teer === "2-3"){
    const req = CONFIG.clbRequired[a.teer];
    if (lang.min === null){
      const p=Math.round(lvlPart*0.45);
      langPts += p;
      details.push(`CLB/NCLC : +${p} (à confirmer, requis ${req})`);
    } else if (lang.min >= req){
      langPts += lvlPart;
      details.push(`CLB/NCLC (min ${lang.min} ≥ ${req}) : +${lvlPart}`);
    } else {
      details.push(`CLB/NCLC (min ${lang.min} < ${req}) : +0`);
    }
  } else {
    // TEER inconnu
    if (lang.min === null){
      const p=Math.round(lvlPart*0.45);
      langPts += p;
      details.push(`CLB/NCLC : +${p} (à confirmer)`);
    } else {
      const p=Math.round(lvlPart*0.6);
      langPts += p;
      details.push(`CLB/NCLC : +${p} (TEER requis à confirmer)`);
    }
  }

  points += langPts;

  const pct = Math.max(0, Math.min(100, Math.round((points/max)*100)));
  return { pct, details, lang };
}

function evaluate(){
  const a = readAnswers();
  const missing = [];
  const hardStopHits = [];

  // Unknowns
  if (a.outsideQC === "unknown") missing.push(CONFIG.unknownMessages.outsideQC);
  if (a.months === null && a.hours === null) missing.push(CONFIG.unknownMessages.months);
  if (a.authPaid === "unknown") missing.push(CONFIG.unknownMessages.authPaid);
  if (a.fulltimeStudent === "unknown") missing.push(CONFIG.unknownMessages.fulltimeStudent);
  if (a.selfEmployed === "unknown") missing.push(CONFIG.unknownMessages.selfEmployed);
  if (a.teer === "unknown") missing.push(CONFIG.unknownMessages.teer);
  if (a.langValid === "unknown") missing.push(CONFIG.unknownMessages.langValid);

  if (a.langTest === "unknown") missing.push(CONFIG.unknownMessages.langTest);
  if ([a.langL,a.langS,a.langR,a.langW].some(v => v === null)) missing.push(CONFIG.unknownMessages.langScores);

  // Hard stops
  for (const hs of CONFIG.hardStops){
    if (hs.check(a)) hardStopHits.push(hs.message);
  }

  const { pct, details, lang } = computeScore(a);

  // Verdict
  let verdict = "POTENTIELLEMENT ADMISSIBLE";
  let badgeClass = "b-warn";

  if (hardStopHits.length > 0){
    verdict = "NON ADMISSIBLE (selon les réponses)";
    badgeClass = "b-bad";
  } else if (pct >= 90 && missing.length === 0){
    verdict = "ADMISSIBLE (pré-évaluation)";
    badgeClass = "b-ok";
  }

  // Render
  $("card_result").classList.remove("hidden");
  const badge = $("badge");
  badge.textContent = verdict;
  badge.className = `badge ${badgeClass}`;
  $("score").textContent = `${pct}%`;

  // Summary
  const parts = [];
  if (hardStopHits.length > 0){
    parts.push("Un ou plusieurs critères bloquants semblent non satisfaits. Voir la liste ci-dessous.");
  } else if (pct >= 90 && missing.length === 0){
    parts.push("Les critères principaux semblent satisfaits sur la base des informations fournies.");
  } else {
    parts.push("Profil proche mais des éléments doivent être confirmés / corrigés.");
  }

  if (a.teer === "0-1" || a.teer === "2-3"){
    const req = CONFIG.clbRequired[a.teer];
    if (lang.min !== null){
      parts.push(`Langue : ${lang.label} — minimum (L/S/R/W) = ${lang.min}. Seuil requis = ${req} (selon TEER).`);
      if (lang.details){
        parts.push(`Détail L/S/R/W : ${lang.details.L}/${lang.details.S}/${lang.details.R}/${lang.details.W}.`);
      }
    } else {
      parts.push(`Langue : à confirmer. Seuil requis = ${req} (selon TEER).`);
    }
  } else {
    parts.push("Le TEER doit être confirmé pour valider le seuil de langue.");
  }

  $("summary").textContent = parts.join(" ");

  // Missing list
  const missingEl = $("missing");
  missingEl.innerHTML = "";
  if (hardStopHits.length > 0){
    for (const m of hardStopHits) addLi(missingEl, m);
  }
  if (missing.length > 0){
    for (const m of missing) addLi(missingEl, m);
  }
  if (hardStopHits.length === 0 && missing.length === 0){
    addLi(missingEl, "Aucun élément manquant identifié (selon les réponses).");
  }

  // Details
  const detailsEl = $("details");
  detailsEl.innerHTML = "";
  for (const d of details) addLi(detailsEl, d);
}

/* =========================
   Events (robuste)
   ========================= */

document.addEventListener("DOMContentLoaded", () => {
  const btnCalc = $("btn_calc");
  const btnReset = $("btn_reset");

  if (btnCalc){
    btnCalc.addEventListener("click", (e) => {
      e.preventDefault();
      evaluate();
      $("card_result").scrollIntoView({behavior:"smooth", block:"start"});
    });
  }

  if (btnReset){
    btnReset.addEventListener("click", (e) => {
      e.preventDefault();

      $("q_outside_qc").value = "unknown";
      $("q_months_can").value = "";
      $("q_hours_can").value = "";
      $("q_auth_paid").value = "unknown";
      $("q_fulltime_student").value = "unknown";
      $("q_self_employed").value = "unknown";
      $("q_teer").value = "unknown";
      $("q_lang_valid").value = "unknown";

      $("q_lang_test").value = "unknown";
      $("q_lang_L").value = "";
      $("q_lang_S").value = "";
      $("q_lang_R").value = "";
      $("q_lang_W").value = "";

      $("q_notes").value = "";
      $("card_result").classList.add("hidden");
    });
  }
});
</script>
</body>
</html>
